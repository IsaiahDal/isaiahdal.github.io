<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Center</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap"> <!-- For Montserrat font-family-->
    <link rel="stylesheet" href="styles.css"> <!-- Page Layout -->
    <link rel="stylesheet" href="dcstyles.css"> <!-- Page Layout -->

</head>
<body>

  <!-- Top Ribbon -->
  <header>
      <div id="header-left">

          <!-- Data Collection Select Toggle -->
          <button id="toc-toggle" onclick="toggleTOC()">â˜°</button>

          <!-- Link to GitHub Repository -->
          <a href="https://github.com/IsaiahDal/isaiahdal.github.io" target="_blank">
              <img src="https://github.githubassets.com/assets/GitHub-Mark-ea2971cee799.png" alt="GitHub Link" id="github-link">
          </a>

          <!-- Title and Author -->
          <h1>
            <a href="https://www.aeaweb.org/articles?id=10.1257/mac.2.4.88" target = "_blank">
              Measuring Business Productivity and Value
            </a>
            <br>
            <a href="http://users.econ.umn.edu/~erm/" target = "_blank" class="author">Ellen McGrattan</a>
          </h1>

      </div>

      <div style="display: flex; text-align: center; width: 30vw; padding: 3vh 1vw;">
        <button class="tab-Btn active" onclick="location.href='dataCenter.html';">Data Center</button>    
        <button class="tab-Btn" onclick="location.href='index.html';">Lectures ðŸ——</button> 
      </div>

      <!-- Link to HHEI -->
      <div id="hhei-image">
          <a href="https://cla.umn.edu/heller-hurwicz" target="_blank">
              <img src="https://cla.umn.edu/sites/cla.umn.edu/files/HHEI%20wordmark.png" alt="Heller-Hurwicz Economics Institute" id="HHEI-Logo">
          </a>
      </div>

  </header>

   <!-- Data Collection Select -->
  <div id="toc" class="hidden">
      <h2>Datasets</h2>
      <!-- Add new datasets here -->
        <!-- IRS SOI -->
      <a href="https://www.irs.gov/statistics/soi-tax-stats-statistics-of-income" target="_blank"><h3>IRS Statistics of Income (SOI)</h3></a>

      <!-- All Corporations -->
      <button id="allcorp" class="toc-entry" style="font-weight: bold;" onclick=
        "buildTablesFromCSV(
          'DATA/allcorp.csv',
          'Total assets', 
          'Other liabilities',
          headers = ['Total assets', 'Total liabilities']
        ); toggleTOC();"
      ><p>All Corportations</p></button>

      <!-- S Corporations -->
      <button id="scorp" class="toc-entry" onclick=
        "buildTablesFromCSV(
          'DATA/scorp.csv',
          'Total assets', 
          'Other liabilities',
          headers = ['Total assets', 'Total liabilities']
        ); toggleTOC();"
      ><p>S Corportations</p></button>

      <!-- Partnerships -->
      <button id="partners" class="toc-entry" onclick=
        "buildTablesFromCSV(
          'DATA/partners.csv',
          'Total assets', 
          'Partners\' capital accounts',
          headers = ['Total assets', 'Total liabilities and capital']
        ); toggleTOC();"
      ><p>Partnerships</p></button>

      <!-- BEA NIPA -->
      <a href="https://apps.bea.gov/iTable/?isuri=1&reqid=19&step=4&categories=flatfiles&nipa_table_list=1" target="_blank"><h3>BEA National Income and Product Accounts (NIPA)</h3></a>
      <button id="DomesticProductAndIncome" class="toc-entry" onclick=
        "buildTablesFromCSV(
          'DATA/GDPGDI.csv',
          'Gross domestic product', 
          'Statistical discrepancy',
          headers = ['Gross domestic product', 'Gross domestic income']
        ); toggleTOC();"
      ><p> Gross Domestic Product And Income</p></button>
  </div>

  <div id="main-content">
    <div id="table-container" class="content-container">
      <div id="table-left" class="table-half"></div>
      <div id="table-right" class="table-half"></div>
    </div>
    <div id="chart-container" class="content-container">
      <div id="download-button-container">
        <button id="download-chart">Download Chart</button>
        <button id="download-series">Download Selected Series</button>
        <button id="download-full">Download Full Dataset</button>
      </div>

      <!-- Chart -->
      <canvas id="data-chart"></canvas>
    </div>
  </div>

  <!-- Year Select Slider -->
  <div id="slider-thumb-left" class="slider-thumb"></div>
  <div id="slider-years">1959 - 2022</div>
  <div id="slider-track-background"></div>
  <div id="slider-track"></div>
  <div id="slider-thumb-right" class="slider-thumb"></div>

  <button id="update-chart">Update Chart</button>


<script>

    let originalCSV = "";


    /* DATASET SELECT */

    // Query all TOC buttons
    const toc = document.getElementById('toc');
    const tocEntries = toc.querySelectorAll('.toc-entry');

    // Add file names and titles to array
    const tabContents = Array.from(tocEntries).map(item => ({
        name: item.id,
        title: item.textContent
    }));

    // Number TOC and change to clicked tab
    tocEntries.forEach((item, index) => {
        item.querySelector('p').textContent = `${index + 1}. ${item.textContent}`
    });


    /* TOGGLE TABLE OF CONTENTS */

    const tocToggle = document.getElementById('toc-toggle');
    let isHidden = true;

    // Toggle functionality
    function toggleTOC() {
        // Show TOC, hide previous/next buttons, and blur tab contents when TOC open
        toc.classList.toggle('hidden');
        document.body.classList.toggle('blurred');

        isHidden = !isHidden;

        // Update toggle button appearance
        tocToggle.textContent = isHidden ? "â˜°" : "X";
    }

  let selectedStartYear = 1959;
  let selectedEndYear   = 2022;

  /* Year Select */ 
  const track = document.getElementById("slider-track");
  const leftThumb = document.getElementById("slider-thumb-left");
  const rightThumb = document.getElementById("slider-thumb-right");

  const sliderYears = document.getElementById("slider-years");

  let activeThumb = null;

  function pointerDown(e) {
    activeThumb = e.target;

    document.body.style.cursor = "grabbing";
    activeThumb.classList.add("dragging");

    document.body.style.userSelect = "none";

    document.addEventListener("pointermove", pointerMove);
    document.addEventListener("pointerup", pointerUp);
  }

  function pointerMove(e) {
    if (!activeThumb) return;

    const thumbWidth = activeThumb.getBoundingClientRect().width;

    // Constrain inside 4vwâ€“94vw
    const minX = window.innerWidth * 0.04 + thumbWidth / 2;
    const maxX = window.innerWidth * 0.94 + thumbWidth / 2;

    let x = Math.max(minX, Math.min(e.clientX, maxX));

    const leftRect = leftThumb.getBoundingClientRect();
    const rightRect = rightThumb.getBoundingClientRect();

    const rightLimit = rightRect.left + thumbWidth / 2;
    const leftLimit = leftRect.right - thumbWidth / 2;


    if (activeThumb === leftThumb) {
      // Prevent left thumb from going past right thumb
      x = Math.min(x, rightLimit);
      track.style.left = `${x}px`;
      track.style.width = `${rightLimit - x}px`;
    }

    if (activeThumb === rightThumb) {
      // Prevent right thumb from going past left thumb
      x = Math.max(x, leftLimit);
      track.style.width = `${x - leftLimit}px`;
    }

    activeThumb.style.left = `${x - thumbWidth / 2}px`;
    activeThumb.style.zIndex = "10";


    // Update years live based on thumb positions
    const minYear = 1959;
    const maxYear = 2022;
    const totalYears = maxYear - minYear;

    const trackMin = window.innerWidth * 0.04;
    const trackMax = window.innerWidth * 0.94;
    const trackWidth = trackMax - trackMin;

    const leftPx = leftThumb.getBoundingClientRect().left;
    const rightPx = rightThumb.getBoundingClientRect().left;

    const leftPercent = (leftPx - trackMin) / trackWidth;
    const rightPercent = (rightPx - trackMin) / trackWidth;

    const leftYear = Math.round(minYear + leftPercent * totalYears);
    const rightYear = Math.round(minYear + rightPercent * totalYears);

    sliderYears.textContent = `${leftYear} - ${rightYear}`;

    selectedStartYear = leftYear;
    selectedEndYear   = rightYear;

    // If changed, show update button
    if (selectedStartYear !== lastAppliedStart || selectedEndYear !== lastAppliedEnd) {
      applyBtn.style.display = "block";
    }

  }

  function pointerUp() {
    if (!activeThumb) return;

    activeThumb = null;
    document.body.style.userSelect = "auto";
    document.removeEventListener("pointermove", pointerMove);
    document.removeEventListener("pointerup", pointerUp);

    document.body.style.cursor = "default";
    leftThumb.classList.remove("dragging");
    rightThumb.classList.remove("dragging");
  }

  [leftThumb, rightThumb].forEach(thumb => {
    thumb.addEventListener("pointerdown", pointerDown);
  });



let csvData = [];
let csvHeaders = [];


async function buildTablesFromCSV(fname, startRow, endRow, headers = []) {
  const leftDiv = document.getElementById('table-left');
  const rightDiv = document.getElementById('table-right');

  leftDiv.innerHTML = '';
  rightDiv.innerHTML = '';

  const text = await fetch(fname).then(r => r.text());
  originalCSV = text;
  const rows = text.split(/\r?\n/).filter(r => r.trim() !== "");

  csvData = [];
  rows.forEach((row, idx) => {
    const cols = parseCSVLine(row); // keep spaces for indentation
    if (idx === 0) csvHeaders = cols;
    else csvData.push(cols);
  });

  let startRowFound = false;
  let endRowFound = false;
  let sectionContainer = leftDiv;
  let leftH2Found = false;

  const indentStack = []; // stack of indent levels

  csvData.forEach(cols => {
    const rawValue = cols[0];

    if (rawValue.includes(startRow)) startRowFound = true;
    if (rawValue.includes(endRow)) endRowFound = true;
    if (!startRowFound || endRowFound) return;

    const value = rawValue.trim();
    if (value.includes("Addendum")) return;

    const indent = rawValue.match(/^\s*/)[0].length;

    let el;
    let level;

    // Explicit h2 overrides indentation
    if (headers.includes(value)) {
      level = 2;
      el = document.createElement("h2");

      if (!leftH2Found) {
        sectionContainer = leftDiv;
        leftH2Found = true;
      } else {
        sectionContainer = rightDiv;
      }

      // reset stack for top-level h2
      indentStack.length = 0;
      indentStack.push(indent);
    } else {
      // Dynamically determine level using indentStack
      while (indentStack.length && indent <= indentStack[indentStack.length - 1]) {
        indentStack.pop();
      }

      indentStack.push(indent);

      level = 3 + indentStack.length - 1; // **start at h3 instead of h2**
      if (level > 6) {
        el = document.createElement("p");
      } else {
        el = document.createElement(`h${level}`);
      }
    }

    el.textContent = value;

    // Store original CSV value for plotting
    el.dataset.plotValue = rawValue;
    el.style.cursor = "pointer";
    el.addEventListener("click", () => plotVariable(el.dataset.plotValue));

    sectionContainer.appendChild(el);
  });

  // Plot the first variable
  plotVariable(startRow);
}



let lastAppliedStart = selectedStartYear;
let lastAppliedEnd   = selectedEndYear;

const applyBtn = document.getElementById("update-chart");

function parseCSVLine(line) {
  const result = [];
  let current = "";
  let inQuotes = false;

  for (let i = 0; i < line.length; i++) {
    const char = line[i];
    const next = line[i + 1];

    if (char === '"' && inQuotes && next === '"') {
      // escaped quote
      current += '"';
      i++;
    } else if (char === '"') {
      inQuotes = !inQuotes;
    } else if (char === ',' && !inQuotes) {
      // First column stays as string, rest are parsed as numbers
      if (result.length === 0) {
        result.push(current); // Keep first column as string (with spaces for indentation)
      } else {
        const cleaned = current.trim().replace(/,/g, '');
        const parsed = parseFloat(cleaned); // Use parseFloat instead of parseInt
        result.push(isNaN(parsed) ? current : parsed);
      }
      current = "";
    } else {
      current += char;
    }
  }

  // Handle the last value (always numeric)
  const cleaned = current.trim().replace(/,/g, '');
  const parsed = parseFloat(cleaned); // Use parseFloat instead of parseInt
  result.push(isNaN(parsed) ? current : parsed);
  
  return result;
}

let currentVariable = null;

function plotVariable(label) {
  currentVariable = label;   // remember which line is plotted
  updateChartRange();
}

function updateChartRange() {
  if (!currentVariable) return;

  const row = csvData.find(r => r[0] === currentVariable);
  if (!row) return;

  const allYears = csvHeaders.slice(1).map(Number);

  console.log("RAW ROW:", row);
  const allValues = row.slice(1).map(v => parseFloat(v));

  console.log("PROCESSED ROW:", allValues);

  // Filter: keep points where year is within slider limits
  const filteredYears = [];
  const filteredValues = [];

  for (let i = 0; i < allYears.length; i++) {
    const y = allYears[i];
    if (y >= selectedStartYear && y <= selectedEndYear) {
      filteredYears.push(y);
      filteredValues.push(allValues[i]);
    }
  }

  renderChart(currentVariable, filteredYears, filteredValues);
}


let chart;

function renderChart(label, years, values) {
  const ctx = document.getElementById("data-chart");

  if (chart) chart.destroy();

  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels: years,
      datasets: [{
        label: label,
        data: values,
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
      y: {
        ticks: {
          callback: function(value) {
            return value.toString(); // no formatting
          }
        }
      }
    }
    },
    plugins: [{
      id: 'custom_canvas_background_color',
      beforeDraw: (chartInstance) => {
        const ctx = chartInstance.ctx;
        ctx.save();
        ctx.globalCompositeOperation = 'destination-over';
        ctx.fillStyle = 'white'; // set your background color here
        ctx.fillRect(0, 0, chartInstance.width, chartInstance.height);
        ctx.restore();
      }
    }]
  });
}

// Call it with your CSV path:
buildTablesFromCSV(
  "DATA/allcorp.csv",
  "Total assets", 
  "Other liabilities",
  headers = ["Total assets", "Total liabilities"]
);

applyBtn.addEventListener("click", () => {
  lastAppliedStart = selectedStartYear;
  lastAppliedEnd   = selectedEndYear;

  updateChartRange();

  applyBtn.style.display = "none";
});

document.getElementById("download-chart").addEventListener("click", () => {
  if (!chart) return;

  const link = document.createElement("a");
  link.download = `${currentVariable}.png`;
  link.href = chart.toBase64Image();
  link.click();
});

document.getElementById("download-series").addEventListener("click", () => {
  if (!currentVariable) return;

  const row = csvData.find(r => r[0] === currentVariable);
  if (!row) return;

  const years = csvHeaders.slice(1).map(Number);
  const values = row.slice(1).map(v => parseFloat(v));

  // Filter by selected years
  let output = "Year,Value\n";
  for (let i = 0; i < years.length; i++) {
    if (years[i] >= selectedStartYear && years[i] <= selectedEndYear) {
      output += `${years[i]},${values[i]}\n`;
    }
  }

  const blob = new Blob([output], { type: "text/csv" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `${currentVariable}_filtered_${selectedStartYear}-${selectedEndYear}.csv`;
  link.click();
});

document.getElementById("download-full").addEventListener("click", () => {
  if (!originalCSV) return;

  const blob = new Blob([originalCSV], { type: "text/csv" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `${currentVariable || "dataset"}.csv`;
  link.click();
});


</script>

</body>
    
</html>